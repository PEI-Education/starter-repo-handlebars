[
    ~[tlist_sql;
      with currentTerm as (select
            s.id sid, 
            cc.id ccid,
            sg.course_number,
            sg.course_name,
            sg.teacher_name,
            sg.comment_value,
            nvl(sg.absences,0) as absences,
            nvl(sg.tardies,0) as lates
        from students s
        join cc on cc.studentid = s.id
        join storedgrades sg
            on sg.studentid = cc.studentid and sg.sectionid = cc.sectionid
        where
            ~[if.~(gpv.dothisfor)=selected] s.dcid in (select dcid from ~[temp.table.current.selection:students])[/if]
            ~[if.~(gpv.dothisfor)=enrolled] s.Enroll_Status = 0[/if]
            ~[if.~(gpv.dothisfor;num)>0] s.id = ~(gpv.dothisfor)[/if]
            ~[if.is.a.school] and sg.schoolid = ~(curschoolid) [/if.is.a.school]
            and sg.storecode = '~(gpv.storecode)'
            and sg.termid = '~[x:termid]'
            and cc.termid > 0),
    termGrades as (select
            s.id sid,
            sg.course_number,
            sg.storecode,
            sg.grade
        from students s
        join storedgrades sg 
            on sg.studentid = s.id
        where 
            ~[if.~(gpv.dothisfor)=selected] s.dcid in (select dcid from ~[temp.table.current.selection:students])[/if]
            ~[if.~(gpv.dothisfor)=enrolled] s.Enroll_Status = 0[/if]
            ~[if.~(gpv.dothisfor;num)>0] s.id = ~(gpv.dothisfor)[/if]
            ~[if.is.a.school] and sg.schoolid = ~(curschoolid) [/if.is.a.school]
            and sg.termid = '~[x:termid]'),
       gradesPivot as (select *
            from termGrades
            PIVOT (
            MAX ( grade )
            FOR storecode
            IN ( 'I1' I1, 'I2' I2, 'I3' I3, 'I4' I4 ))
            order by id, ccid, course_number)
              
        select
            ct.id id,
            gp.ccid ccid,
            ct.course_number,
            ct.course_name,
            ct.teacher_name,
            ct.comment_value,
            ct.absences,
            ct.lates,
            gp.i1,
            gp.i2,
            gp.i3,
            gp.i4
        from currentTerm ct
        join gradesPivot gp
            on ct.id=gp.id and ct.course_number = gp.course_number
        order by ct.id;
    ]
    {
        "id":               "~(id;json)",
        "ccid":             "~(ccid;json)",
        "course_number":    "~(course_number;json)",
        "course_name":      "~(cname;json)",
        "teacher":          "~(teacher;json)",
        "comment":          "~(comment;json)",
        "absences":         "~(absences;json)",
        "lates":            "~(tardies;json)",
        "i1grade":          "~(i1;json)",
        "i2grade":          "~(i2;json)",
        "i3grade":          "~(i3;json)",
        "i4grade":          "~(i4;json)"
    },    
    [/tlist_sql]
    {}
]