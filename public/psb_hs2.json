[
   ~[x:GetDoThisForStudents]
   ~[x:SortSelection;Students:~[displayprefschool:report_card_sort]]
   ~[RepeatForEach:Students]
   ~[tlist_sql;
   with scoursegrades as (select
   sg.studentid,
   sg.sectionid,
   case substr(sg.course_number,5,1)
      when '0' then 'Open'
      when '1' then 'Advanced'
      when '2' then 'Academic'
      when '3' then 'General'
      when '4' then 'Vocational'
      when '5' then 'Vocational'
      when '6' then 'Modified'
      when '7' then 'Intervention'     
   end as course_level,
   sg.storecode,
   sg.grade
from storedgrades sg
where sg.studentid = ~(curstudid)
and sg.termid = ~(gpv.termid)
),

/*coteachers as (
  select distinct
      cotea.sectionid,
      JSON_ARRAYAG(cotea.id order by 
  from sectionteacher cotea
  inner join teachers tea
      on cotea.teacherid = tea.id
  inner join scoursegrades scg
    on cotea.sectionid = scg.sectionid
  where cotea.roleid = 42
  group by cotea.sectionid
),*/

sgradespivot as (select *
from scoursegrades
PIVOT (
MAX ( grade )
FOR storecode
IN ( 'Q1' Q1, 'S1' S1, 'Q3' Q3, 'S2' S2 ))
order by studentid, sectionid, course_level),

fycoursegrades as (select
   sg.studentid,
   sg.sectionid,
   case substr(sg.course_number,5,1)
      when '0' then 'Open'
      when '1' then 'Advanced'
      when '2' then 'Academic'
      when '3' then 'General'
      when '4' then 'Vocational'
      when '5' then 'Vocational'
      when '6' then 'Modified'
      when '7' then 'Intervention'     
      end as course_level,
      sg.storecode,
      sg.grade
   from storedgrades sg
   where sg.studentid = ~(curstudid)
   and sg.termid = '~(curyearid)00'),

   fygradespivot as (select *
   from fycoursegrades
   PIVOT (
   MAX ( grade )
   FOR storecode
   IN ( 'Q1' Q1, 'Q2' Q2, 'Q3' Q3, 'Q4' Q4 ))
   order by studentid, sectionid, course_level)

   select JSON_OBJECT (
      'sid'             value s.id ,
      'scoolid'         value s.schoolid,
      'school'          value sch.name,
      'principal'       value sch.principal,
      'student_number'  value s.student_number,
      'home_room'       value s.home_room,
      'first_name'      value s.first_name,
      'last_name'       value s.last_name,
      'dob'             value s.dob,
      'grade_level'     value s.grade_level,
      'semCourses'      value JSON_ARRAYAGG 
      (
      JSON_OBJECT
      (
      'sectionid'       value sg.sectionid,
      'course_name'     value sg.course_name,
      'course_number'   value sg.course_number,
      'comment'         value sg.comment_value,
      'absences'        value sg.absences,
      'lates'           value sg.tardies,
      'course_level'    value sgv.course_level,
      'q1'              value sgv.q1,
      's1'              value sgv.s1,
      'q3'              value sgv.q3,
      's2'              value sgv.s2,
      'teacher'         value (tea.first_name || ' ' || tea.last_name)
      --'coteachers'      value ct.coTeaList
      )
      ) FORMAT JSON,
      'fyCourses'       value JSON_ARRAYAGG 
      (
      JSON_OBJECT
      (
      'sectionid'       value sg.sectionid,
      'course_name'     value sg.course_name,
      'course_number'   value sg.course_number,
      'comment'         value sg.comment_value,
      'absences'        value sg.absences,
      'lates'           value sg.tardies,
      'course_level'    value fgv.course_level,
      'q1'              value fgv.q1,
      'q2'              value fgv.q2,
      'q3'              value fgv.q3,
      'q4'              value fgv.q4,
      'teacher'         value (tea.first_name || ' ' || tea.last_name)
      )
      ) FORMAT JSON
      ) JSON_VALUE
   from students s
   join schools sch
      on sch.school_number = s.schoolid
   join cc
      on cc.studentid = s.id
   join storedgrades sg
      on cc.studentid = sg.studentid
      and cc.sectionid = sg.sectionid
   left  join sgradespivot sgv
      on s.id = sgv.studentid
   left join fygradespivot fgv
   on s.id = fgv.studentid
   join sections sec
   on sec.id = cc.sectionid
   join teachers tea
   on tea.id = sec.teacher
   --join coteachers ct
   --on ct.sectionid = cc.sectionid
   where 
         s.id = ~(curstudid)
      and s.schoolid = ~(curschoolid)
      and cc.termid in ('~(gpv.yearid)00','~(gpv.termid)')
      and sg.storecode = '~(gpv.storecode)'
      group by s.id, s.schoolid, sch.name, sch.principal,s.student_number,s.home_room,s.first_name,s.last_name,s.dob,s.grade_level
   order by s.id;
         ]
        ~(1)
   [/tlist_sql]
   [between:Students],
   [/RepeatForEach:Students] 
]