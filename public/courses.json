[
    ~[tlist_sql;
        with currentTerm as (select
            s.id,
            sg.course_number,
            sg.course_name,
            sg.teacher_name,
            sg.comment_value
        from students s
        join cc on cc.studentid = s.id
        join storedgrades sg
            on sg.studentid = cc.studentid and sg.sectionid = cc.sectionid
        where
            ~[if.~(gpv.dothisfor)=selected] s.dcid in (select dcid from ~[temp.table.current.selection:students])[/if]
            ~[if.~(gpv.dothisfor)=enrolled] s.Enroll_Status = 0[/if]
            ~[if.~(gpv.dothisfor;num)>0] s.id = ~(gpv.dothisfor)[/if]
            ~[if.is.a.school] and sg.schoolid = ~(curschoolid) [/if.is.a.school]
            and sg.storecode = '~(gpv.storecode)'
            and sg.termid = ~(curtermid)
            and cc.termid > 0),
        termGrades as (select
            s.id,
            sg.course_number,
            sg.storecode,
            sg.grade
        from students s
        join storedgrades sg 
            on sg.studentid = s.id
        where 
            ~[if.~(gpv.dothisfor)=selected] s.dcid in (select dcid from ~[temp.table.current.selection:students])[/if]
            ~[if.~(gpv.dothisfor)=enrolled] s.Enroll_Status = 0[/if]
            ~[if.~(gpv.dothisfor;num)>0] s.id = ~(gpv.dothisfor)[/if]
            ~[if.is.a.school] and sg.schoolid = ~(curschoolid) [/if.is.a.school]
            and sg.termid = ~(curtermid)),
        gradesPivot as (select *
            from termGrades
            PIVOT (
            MAX ( grade )
            FOR storecode
            IN ( 'I1' I1, 'I2' I2, 'I3' I3, 'I4' I4 ))
            order by id, course_number)
            
        select
            ct.id,
            ct.course_number,
            ct.course_name,
            ct.teacher_name,
            ct.comment_value,
            gp.i1,
            gp.i2,
            gp.i3,
            gp.i4,
            case 
                when substr(ct.course_number,2,5) = 'ENGA' then rpt.e_ela_adaptation
                WHEN substr(ct.course_number,2,5) = 'FREF' then rpt.e_fla_adaptation
                WHEN substr(ct.course_number,2,5) = 'FREG' then rpt.e_fla_adaptation
                WHEN substr(ct.course_number,2,5) = 'FREA' then rpt.e_fre_adaptation
                WHEN substr(ct.course_number,2,4) = 'MAT' then rpt.e_math_adaptation
                WHEN substr(ct.course_number,2,4) = 'CTE' then rpt.e_cte_adaptation
                WHEN substr(ct.course_number,2,5) = 'EXPA' then rpt.e_expa_adaptation
                WHEN substr(ct.course_number,2,5) = 'EXPB' then rpt.e_expb_adaptation
                WHEN substr(ct.course_number,2,4) = 'ART' then rpt.e_art_adaptation
                WHEN substr(ct.course_number,2,4) = 'HEC' then rpt.e_hec_adaptation
                WHEN substr(ct.course_number,2,5) = 'MKQK' then rpt.e_mkqk_adaptation
                WHEN substr(ct.course_number,2,5) = 'MUSA' then rpt.e_mus_adaptation
                WHEN substr(ct.course_number,2,4) = 'PED' then rpt.e_ped_adaptation
                WHEN substr(ct.course_number,2,5) = 'PHEA' then rpt.e_ped_adaptation
                WHEN substr(ct.course_number,2,4) = 'SCI' then rpt.e_sci_adaptation
                WHEN substr(ct.course_number,2,4) = 'SOC' then rpt.e_soc_adaptation
            else
                0
            end as adaptation,
            case 
                WHEN substr(ct.course_number,2,4) = 'ART' then rpt.e_art_program
                WHEN substr(ct.course_number,2,4) = 'CTE' then rpt.e_cte_program
                WHEN substr(ct.course_number,2,5) = 'ENGA' then rpt.e_ela_program
                WHEN substr(ct.course_number,2,5) = 'EXPA' then rpt.e_expa_program
                WHEN substr(ct.course_number,2,5) = 'EXPB' then rpt.e_expb_program        
                WHEN substr(ct.course_number,2,5) = 'FREF' then rpt.e_fla_program
                WHEN substr(ct.course_number,2,5) = 'FREG' then rpt.e_fla_program
                WHEN substr(ct.course_number,2,5) = 'FREA' then rpt.e_fre_program
                WHEN substr(ct.course_number,2,4) = 'HEC' then rpt.e_hec_program        
                WHEN substr(ct.course_number,2,4) = 'MAT' then rpt.e_math_program
                WHEN substr(ct.course_number,2,5) = 'MKQK' then rpt.e_mkqk_program
                WHEN substr(ct.course_number,2,5) = 'MUSA' then rpt.e_mus_program
                WHEN substr(ct.course_number,2,4) = 'PED' then rpt.e_ped_program
                WHEN substr(ct.course_number,2,5) = 'PHEA' then rpt.e_ped_program
                WHEN substr(ct.course_number,2,4) = 'SCI' then rpt.e_sci_program
                WHEN substr(ct.course_number,2,4) = 'SOC' then rpt.e_soc_program
            else
                'Regular'
            end as program,
            case
                WHEN substr(ct.course_number,2,5) = 'ENGA' then rpt.e_ela_iep
                WHEN substr(ct.course_number,2,5) = 'FREF' then rpt.e_fla_iep
                WHEN substr(ct.course_number,2,5) = 'FREG' then rpt.e_fla_iep
                WHEN substr(ct.course_number,2,4) = 'MAT' then rpt.e_math_iep
            else
                0
            end as iep,
            case
                WHEN substr(ct.course_number,2,5) = 'ENGA' then rpt.e_ela_eal
                WHEN substr(ct.course_number,2,5) = 'FREF' then rpt.e_fla_eal
                WHEN substr(ct.course_number,2,5) = 'FREG' then rpt.e_fla_eal
                WHEN substr(ct.course_number,2,4) = 'MAT' then rpt.e_mat_eal
            else
                0
            end as eal,
            case 
                WHEN substr(ct.course_number,2,4) = 'ART' then rpt.e_art_effort_r1
                WHEN substr(ct.course_number,2,4) = 'CTE' then rpt.e_cte_effort_r1
                WHEN substr(ct.course_number,2,5) = 'ENGA' then rpt.e_ela_effort_r1
                WHEN substr(ct.course_number,2,5) = 'EXPA' then rpt.e_expa_effort_r1
                WHEN substr(ct.course_number,2,5) = 'EXPB' then rpt.e_expb_effort_r1        
                WHEN substr(ct.course_number,2,5) = 'FREF' then rpt.e_fla_effort_r1
                WHEN substr(ct.course_number,2,5) = 'FREG' then rpt.e_fla_effort_r1
                WHEN substr(ct.course_number,2,5) = 'FREA' then rpt.e_fre_effort_r1
                WHEN substr(ct.course_number,2,4) = 'HEC' then rpt.e_hec_effort_r1        
                WHEN substr(ct.course_number,2,4) = 'MAT' then rpt.e_mat_effort_r1
                WHEN substr(ct.course_number,2,5) = 'MKQK' then rpt.e_mkqk_effort_r1
                WHEN substr(ct.course_number,2,5) = 'MUSA' then rpt.e_mus_effort_r1
                WHEN substr(ct.course_number,2,4) = 'PED' then rpt.e_phea_effort_r1
                WHEN substr(ct.course_number,2,5) = 'PHEA' then rpt.e_phea_effort_r1
                WHEN substr(ct.course_number,2,4) = 'SCI' then rpt.e_sci_effort_r1
                WHEN substr(ct.course_number,2,4) = 'SOC' then rpt.e_soc_effort_r1
            else
                null
            end as effort1,
                case 
                WHEN substr(ct.course_number,2,4) = 'ART' then rpt.e_art_effort_r2
                WHEN substr(ct.course_number,2,4) = 'CTE' then rpt.e_cte_effort_r2
                WHEN substr(ct.course_number,2,5) = 'ENGA' then rpt.e_ela_effort_r2
                WHEN substr(ct.course_number,2,5) = 'EXPA' then rpt.e_expa_effort_r2
                WHEN substr(ct.course_number,2,5) = 'EXPB' then rpt.e_expb_effort_r2        
                WHEN substr(ct.course_number,2,5) = 'FREF' then rpt.e_fla_effort_r2
                WHEN substr(ct.course_number,2,5) = 'FREG' then rpt.e_fla_effort_r2
                WHEN substr(ct.course_number,2,5) = 'FREA' then rpt.e_fre_effort_r2
                WHEN substr(ct.course_number,2,4) = 'HEC' then rpt.e_hec_effort_r2        
                WHEN substr(ct.course_number,2,4) = 'MAT' then rpt.e_mat_effort_r2
                WHEN substr(ct.course_number,2,5) = 'MKQK' then rpt.e_mkqk_effort_r2
                WHEN substr(ct.course_number,2,5) = 'MUSA' then rpt.e_mus_effort_r2
                WHEN substr(ct.course_number,2,4) = 'PED' then rpt.e_phea_effort_r2
                WHEN substr(ct.course_number,2,5) = 'PHEA' then rpt.e_phea_effort_r2
                WHEN substr(ct.course_number,2,4) = 'SCI' then rpt.e_sci_effort_r2
                WHEN substr(ct.course_number,2,4) = 'SOC' then rpt.e_soc_effort_r2
            else
                null
            end as effort2,    
            case 
                WHEN substr(ct.course_number,2,4) = 'ART' then rpt.e_art_effort_r3
                WHEN substr(ct.course_number,2,4) = 'CTE' then rpt.e_cte_effort_r3
                WHEN substr(ct.course_number,2,5) = 'ENGA' then rpt.e_ela_effort_r3
                WHEN substr(ct.course_number,2,5) = 'EXPA' then rpt.e_expa_effort_r3
                WHEN substr(ct.course_number,2,5) = 'EXPB' then rpt.e_expb_effort_r3        
                WHEN substr(ct.course_number,2,5) = 'FREF' then rpt.e_fla_effort_r3
                WHEN substr(ct.course_number,2,5) = 'FREG' then rpt.e_fla_effort_r3
                WHEN substr(ct.course_number,2,5) = 'FREA' then rpt.e_fre_effort_r3
                WHEN substr(ct.course_number,2,4) = 'HEC' then rpt.e_hec_effort_r3        
                WHEN substr(ct.course_number,2,4) = 'MAT' then rpt.e_mat_effort_r3
                WHEN substr(ct.course_number,2,5) = 'MKQK' then rpt.e_mkqk_effort_r3
                WHEN substr(ct.course_number,2,5) = 'MUSA' then rpt.e_mus_effort_r3
                WHEN substr(ct.course_number,2,4) = 'PED' then rpt.e_phea_effort_r3
                WHEN substr(ct.course_number,2,5) = 'PHEA' then rpt.e_phea_effort_r3
                WHEN substr(ct.course_number,2,4) = 'SCI' then rpt.e_sci_effort_r3
                WHEN substr(ct.course_number,2,4) = 'SOC' then rpt.e_soc_effort_r3
            else
                null
            end as effort3,
            case 
                WHEN substr(ct.course_number,2,4) = 'ART' then rpt.e_art_effort_r4
                WHEN substr(ct.course_number,2,4) = 'CTE' then rpt.e_cte_effort_r4
                WHEN substr(ct.course_number,2,5) = 'ENGA' then rpt.e_ela_effort_r4
                WHEN substr(ct.course_number,2,5) = 'EXPA' then rpt.e_expa_effort_r4
                WHEN substr(ct.course_number,2,5) = 'EXPB' then rpt.e_expb_effort_r4        
                WHEN substr(ct.course_number,2,5) = 'FREF' then rpt.e_fla_effort_r4
                WHEN substr(ct.course_number,2,5) = 'FREG' then rpt.e_fla_effort_r4
                WHEN substr(ct.course_number,2,5) = 'FREA' then rpt.e_fre_effort_r4
                WHEN substr(ct.course_number,2,4) = 'HEC' then rpt.e_hec_effort_r4        
                WHEN substr(ct.course_number,2,4) = 'MAT' then rpt.e_mat_effort_r4
                WHEN substr(ct.course_number,2,5) = 'MKQK' then rpt.e_mkqk_effort_r4
                WHEN substr(ct.course_number,2,5) = 'MUSA' then rpt.e_mus_effort_r4
                WHEN substr(ct.course_number,2,4) = 'PED' then rpt.e_phea_effort_r4
                WHEN substr(ct.course_number,2,5) = 'PHEA' then rpt.e_phea_effort_r4
                WHEN substr(ct.course_number,2,4) = 'SCI' then rpt.e_sci_effort_r4
                WHEN substr(ct.course_number,2,4) = 'SOC' then rpt.e_soc_effort_r4
            else
                null
            end as effort4
        from currentTerm ct
        join gradesPivot gp
            on ct.id=gp.id and ct.course_number = gp.course_number
        join students s 
            on ct.id = s.id
        left join u_def_ext_students0 rpt
            on rpt.studentsdcid=s.dcid
        order by id
    ]
    {
        "id": "~(id)",
        "course_number": "~(course_number;json)",
        "course_name": "~(cname;json)",
        "teacher": "~(teacher)",
        "comment": "~(comment;json)",
        "i1grade": "~(i1;json)",
        "i2grade": "~(i2;json)",
        "i3grade": "~(i3;json)",
        "i4grade": "~(i4;json)",
        "adaptation": "~(adaptation;json)",
        "program": "~(program;json)",
        "iep": "~(iep;json)",
        "eal": "~(eal;json)",
        "r1effort": "~(effort1;json)",
        "r2effort": "~(effort2;json)",
        "r3effort": "~(effort3;json)",
        "r4effort": "~(effort4;json)"
    },    
    [/tlist_sql]
    {}
    ]